<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ç·šä¸Šè¨‚è³¼</title>
  <link rel="stylesheet" href="css/order.css">
</head>

<body>

  <!-- ===== Navbar ===== -->
  <header>
    <nav class="navbar">
      <ul class="nav-links">
        <li><a href="/homepage">é¦–é </a></li>
        <li><a href="/menu">èœå–®</a></li>
        <li><a href="/order" class="active">ç·šä¸Šè¨‚è³¼</a></li>
        <li><a href="/storepage">é–€å¸‚æ“šé»</a></li>
        <li><a href="/brandStory">å“ç‰Œæ•…äº‹</a></li>
        <li><a href="/frequentlyaskedquestions">å¸¸è¦‹å•é¡Œ</a></li>
      </ul>

      <div class="hamburger">
        <span></span><span></span><span></span>
      </div>
    </nav>
  </header>

  <main>
    <section class="hero">
      <h1>ç·šä¸Šè¨‚è³¼</h1>
    </section>

    <section class="container">
      <!-- å•†å“å€ -->
      <div class="products" id="products"></div>

      <!-- è³¼ç‰©è»Š -->
      <aside class="cart">
        <h3>è³¼ç‰©è»Š</h3>
        <ul id="cartList"></ul>
        <p>ç¸½é‡‘é¡ï¼šNT$ <span id="total">0</span></p>

        <div class="checkout">
          <input type="text" id="name" placeholder="å§“å" />
          <input type="tel" id="phone" placeholder="é›»è©±" />
          <select id="pickup">
            <option value="">å–é¤æ–¹å¼</option>
            <option>é–€å¸‚è‡ªå–</option>
            <option>å¤–é€</option>
          </select>
          <button onclick="submitOrder()">é€å‡ºè¨‚å–®</button>
        </div>
      </aside>
    </section>
  </main>

  <footer>
    Â© 2025 é£²æ–™åº—ç·šä¸Šè¨‚è³¼ç³»çµ±
  </footer>

  <script>
    const products = [
      { name: 'æœˆå…‰ç«ç‘°', price: { M: 90, L: 110 }, img: '/img/order-img/1moonlight_rose.png' },
      { name: 'æ™¨éœ²æª¸æª¬', price: { M: 85, L: 100 }, img: '/img/order-img/2morning_lemon.png' },
      { name: 'é›²ç«¯ç„¦ç³–', price: { M: 95, L: 115 }, img: '/img/order-img/3cloud_caramel.png' },
      { name: 'æ˜Ÿé›²è“æœ', price: { M: 100, L: 120 }, img: '/img/order-img/4nebula_berry.png' },
      { name: 'æœˆå½±æŠ¹èŒ¶', price: { M: 100, L: 120 }, img: '/img/order-img/5moonlight_matcha.png' },
      { name: 'ç„¦ç³–é›²æœµ', price: { M: 95, L: 110 }, img: '/img/order-img/6caramel_cloud.png' },
      { name: 'æ˜ŸèªèŒ‰è‰', price: { M: 90, L: 110 }, img: '/img/order-img/7star_jasmine.png' },
      { name: 'ç¥ç€çƒé¾', price: { M: 85, L: 100 }, img: '/img/order-img/8amber_oolong.png' },
      { name: 'éœ§ä¹‹è“èª', price: { M: 95, L: 115 }, img: '/img/order-img/9fog_berry.png' },
      { name: 'æ˜Ÿéœ§å¥¶é¦™', price: { M: 95, L: 110 }, img: '/img/order-img/10star_fog_milk.png' },
      { name: 'æ™¨æ›¦èœœæ¡ƒ', price: { M: 85, L: 100 }, img: '/img/order-img/11morning_peach.png' },
      { name: 'æœˆç´—èŠ±èª', price: { M: 90, L: 110 }, img: '/img/order-img/12moon_fog_flower.png' },
      { name: 'æš®å…‰æ‘©å¡', price: { M: 110, L: 130 }, img: '/img/order-img/13moonlight_mocha.png' },
      { name: 'æ˜Ÿå¤œæ‹¿éµ', price: { M: 115, L: 135 }, img: '/img/order-img/14star_night_latte.png' },
      { name: 'æœˆå½±å¡å¸ƒå¥‡è«¾', price: { M: 120, L: 140 }, img: '/img/order-img/15moonlight_cappuccino.png' },
      { name: 'æ˜Ÿè½ç™½ç‰å¥¶èŒ¶', price: { M: 95, L: 115 }, img: '/img/order-img/16star_fog_milk.png' },
      { name: 'éœ²æ™¨é’æª¸æ°£æ³¡', price: { M: 85, L: 100 }, img: '/img/order-img/17morning_lemon_bubble.png' },
      { name: 'æœˆéœœç¥ç€ç´…èŒ¶', price: { M: 90, L: 110 }, img: '/img/order-img/18moon_fog_amber_tea.png' },
      { name: 'æ˜Ÿç©ºç‰ç’ƒ', price: { M: 95, L: 115 }, img: '/img/order-img/19star_luminous.png' },
      { name: 'æœˆæ³‰ç™½éœœ', price: { M: 90, L: 110 }, img: '/img/order-img/20moon_fog_white.png' },
      { name: 'æ›¦å…‰è“èª', price: { M: 100, L: 120 }, img: '/img/order-img/21morning_berry.png' },
      { name: 'æ˜Ÿæ¾ˆé›²æ³¡', price: { M: 95, L: 115 }, img: '/img/order-img/22star_cloud_bubble.png' },
      { name: 'æœˆéœ§é›ªé ‚', price: { M: 105, L: 125 }, img: '/img/order-img/23moon_fog_snow.png' },
      { name: 'æ›¦å…‰æ°£æ³¡', price: { M: 90, L: 110 }, img: '/img/order-img/24morning_bubble.png' }
    ];

    let cart = [];
    const productDiv = document.getElementById('products');

    products.forEach((p, i) => {
      productDiv.innerHTML += `
        <div class="card">
          <img src="${p.img}">
          <div class="info">
            <h4>${p.name}</h4>
            <p>M: NT$ ${p.price.M} / L: NT$ ${p.price.L}</p>

            <div class="form-group">
              <label>å°ºå¯¸ï¼š</label>
              <select id="size-${i}">
                <option value="M">M</option>
                <option value="L">L</option>
              </select>
            </div>

            <div class="form-group">
              <label>æ•¸é‡ï¼š</label>
              <input type="number" id="qty-${i}" value="1" min="1">
            </div>

            <div class="form-group">
              <label>å†°å¡Šï¼š</label>
              <select id="ice-${i}">
                <option>æ­£å¸¸å†°</option>
                <option>å°‘å†°</option>
                <option>å»å†°</option>
              </select>
            </div>

            <div class="form-group">
              <label>ç”œåº¦ï¼š</label>
              <select id="sugar-${i}">
                <option>æ­£å¸¸ç³–</option>
                <option>åŠç³–</option>
                <option>å¾®ç³–</option>
                <option>ç„¡ç³–</option>
              </select>
            </div>

            <button onclick="addToCart(${i})">åŠ å…¥è³¼ç‰©è»Š</button>
          </div>
        </div>
      `;
    });

    // è³¼ç‰©è»Šè¦å­˜ã€Œå®¢è£½åŒ–é¸é …ã€
    function addToCart(i) {
      const p = products[i];

      const size = document.getElementById(`size-${i}`).value; // M / L
      const qty = Math.max(1, parseInt(document.getElementById(`qty-${i}`).value, 10) || 1);
      const ice = document.getElementById(`ice-${i}`).value;
      const sugar = document.getElementById(`sugar-${i}`).value;

      const price = Number(p.price[size]); // å–®åƒ¹ï¼ˆå¾Œç«¯åƒ priceï¼‰
      if (!Number.isFinite(price)) {
        alert('åƒ¹æ ¼è³‡æ–™æœ‰èª¤');
        return;
      }

      cart.push({
        name: p.name,
        size,
        qty,
        ice,
        sugar,
        price
      });

      renderCart();
    }

    // æ­£ç¢ºè¨ˆç®—ç¸½é‡‘é¡ + é¡¯ç¤ºå®¢è£½åŒ–æ˜ç´° + å¯åˆªé™¤
    function renderCart() {
      const list = document.getElementById('cartList');
      list.innerHTML = '';
      let total = 0;

      cart.forEach((item, idx) => {
        const subtotal = item.price * item.qty;
        total += subtotal;

        list.innerHTML += `
          <li>
            <div>
              <b>${item.name}</b>ï¼ˆ${item.size}ï¼‰x ${item.qty}<br>
              <small>${item.ice} / ${item.sugar}</small>
            </div>
            <div>
              NT$ ${subtotal}
              <button onclick="removeItem(${idx})">åˆªé™¤</button>
            </div>
          </li>
        `;
      });

      document.getElementById('total').innerText = total;
    }

    function removeItem(idx) {
      cart.splice(idx, 1);
      renderCart();
    }

  // é€åˆ°å¾Œç«¯ /api/orderï¼Œä¸¦å›å‚³ order_id -- é€å‡ºè¨‚å–®
    async function submitOrder() {
      const nameEl = document.getElementById('name');
      const phoneEl = document.getElementById('phone');
      const pickupEl = document.getElementById('pickup');

      if (cart.length === 0) { alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„'); return }
      if (!nameEl.value.trim() || !phoneEl.value.trim() || !pickupEl.value) {
        alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
        return;
      }
      // trim()ï¼šå»é™¤å‰å¾Œç©ºç™½ -- åªè¦æœ‰ä¸€å€‹æ¬„ä½æ˜¯ç©ºçš„ï¼Œå°±æ•´å€‹è¨‚å–®ä¸é€å‡º

      // ç®— totalï¼ˆé—œéµï¼‰
      const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);

      // payload = è¦é€åˆ° API çš„è³‡æ–™æœ¬é«”ï¼ˆJSONï¼‰-- çµ„æˆè¦é€åˆ°å¾Œç«¯çš„è³‡æ–™
      const payload = {
        customer_name: nameEl.value.trim(),
        phone: phoneEl.value.trim(),
        pickup_method: pickupEl.value,
        total,
        cart: cart.map(item => ({
          name: item.name,
          price: item.price
        }))
      };

      // ç«‹åˆ»é©—è­‰
      console.log('payload total =', payload.total);

      try {
        const res = await fetch('/api/order', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        // fetch æ˜¯æ‹¿ä¾†å‚³é€ POST è«‹æ±‚æ»´ // fetch çš„ body 
           // ğŸ‘‰ åªèƒ½æ¥æ”¶ã€Œå­—ä¸²æˆ–ç‰¹å®šæ ¼å¼ã€ 
           // ğŸ‘‰ ä¸èƒ½ç›´æ¥æ¥æ”¶ JavaScript ç‰©ä»¶

        const data = await res.json();
        alert(`è¨‚å–®æ–°å¢æˆåŠŸï¼è¨‚å–®ç·¨è™Ÿï¼š${data.order_id}`);

        cart = [];
        renderCart();
        nameEl.value = '';
        phoneEl.value = '';
        pickupEl.value = '';
        //âœ” æ¸…ç©ºè³¼ç‰©è»Š âœ” é‡æ–°æ¸²æŸ“ç•«é¢ âœ” æ¸…ç©ºè¡¨å–®

      } catch (err) {
        console.error(err);
        alert('é€å‡ºå¤±æ•—ï¼šç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨');
      }
    }
  </script>
</body>

</html>
